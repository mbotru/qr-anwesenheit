<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anwesenheit Terminal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        #qrcode { margin: 20px auto; display: inline-block; }
        .info-text { color: #555; margin-bottom: 20px; }
        #status { font-size: 0.8em; color: #888; }
        .error { color: #d9534f !important; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Anwesenheit scannen</h2>
        <p class="info-text">Bitte halten Sie den QR-Code vor die Kamera Ihrer App.</p>
        
        <div id="qrcode"></div>
        
        <p id="status">Verbindung zum Server wird aufgebaut...</p>
    </div>

    <script>
        const qrElement = document.getElementById("qrcode");
        const statusText = document.getElementById("status");
        let qrObject = null;

        async function refreshQR() {
            try {
                // WICHTIG: Ruft die Python-Route /get_qr auf
                const response = await fetch('/get_qr');
                
                if (!response.ok) throw new Error("Server-Fehler (404/500)");
                
                const data = await response.json();

                if (data.qr_string) {
                    if (qrObject === null) {
                        // QR-Code zum ersten Mal erzeugen
                        qrObject = new QRCode(qrElement, {
                            text: data.qr_string,
                            width: 250,
                            height: 250
                        });
                    } else {
                        // Bestehenden QR-Code aktualisieren
                        qrObject.makeCode(data.qr_string);
                    }
                    statusText.innerText = "Letztes Update: " + new Date().toLocaleTimeString();
                    statusText.classList.remove("error");
                }
            } catch (err) {
                console.error(err);
                statusText.innerText = "Fehler: Backend nicht erreichbar!";
                statusText.classList.add("error");
            }
        }

        // --- AUTOMATISCHER START ---
        document.addEventListener("DOMContentLoaded", () => {
            // Sofort beim Laden ausf√ºhren
            refreshQR();
            // Alle 15 Sekunden wiederholen
            setInterval(refreshQR, 15000);
        });
    </script>
</body>
</html>
